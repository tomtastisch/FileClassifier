name: CI

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]
  workflow_dispatch:

permissions:
  contents: read

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

jobs:
  pr-labeling:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      issues: write

    steps:
      - name: Checkout Base Branch
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Fetch PR Head Commit
        run: git fetch --no-tags --prune origin ${{ github.event.pull_request.head.sha }}

      - name: Derive Versioning Decision
        id: versioning
        run: |
          set +e
          guard_output=$(BASE_REF=origin/main HEAD_REF=${{ github.event.pull_request.head.sha }} tools/versioning/check-versioning.sh 2>&1)
          guard_exit=$?
          set -e

          echo "$guard_output"

          required=$(printf '%s\n' "$guard_output" | sed -n 's/.*required=\([a-z]*\).*/\1/p' | tail -n1)
          actual=$(printf '%s\n' "$guard_output" | sed -n 's/.*actual=\([a-z]*\).*/\1/p' | tail -n1)

          if [[ -z "$required" ]]; then
            required=$(MODE=required BASE_REF=origin/main HEAD_REF=${{ github.event.pull_request.head.sha }} tools/versioning/check-versioning.sh 2>/dev/null || echo "none")
          fi

          if [[ -z "$actual" ]]; then
            actual="none"
          fi

          reason="guard-derived"
          if [[ "$guard_exit" -ne 0 ]]; then
            reason="guard-unavailable-fallback"
          fi

          echo "required=$required" >> "$GITHUB_OUTPUT"
          echo "actual=$actual" >> "$GITHUB_OUTPUT"
          echo "reason=$reason" >> "$GITHUB_OUTPUT"
          echo "guard_exit=$guard_exit" >> "$GITHUB_OUTPUT"

      - name: Collect PR Metadata
        id: prmeta
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const pr = context.payload.pull_request;

            const files = await github.paginate(
              github.rest.pulls.listFiles,
              { owner, repo, pull_number: pr.number, per_page: 100 }
            );

            const paths = files.map((f) => f.filename);
            const labels = pr.labels.map((l) => l.name);

            core.setOutput('files_json', JSON.stringify(paths));
            core.setOutput('existing_labels_json', JSON.stringify(labels));
            core.setOutput('pr_title', pr.title || '');

      - name: Compute Deterministic Labels (Dry Run)
        env:
          FILES_JSON: ${{ steps.prmeta.outputs.files_json }}
          EXISTING_LABELS_JSON: ${{ steps.prmeta.outputs.existing_labels_json }}
          PR_TITLE: ${{ steps.prmeta.outputs.pr_title }}
          VERSION_REQUIRED: ${{ steps.versioning.outputs.required }}
          VERSION_ACTUAL: ${{ steps.versioning.outputs.actual }}
          VERSION_REASON: ${{ steps.versioning.outputs.reason }}
          VERSION_GUARD_EXIT: ${{ steps.versioning.outputs.guard_exit }}
          OUTPUT_PATH: artifacts/labels/decision.json
        run: |
          mkdir -p artifacts/labels
          node tools/versioning/compute-pr-labels.js
          cat artifacts/labels/decision.json

      - name: Validate Label Decision Contract
        run: node tools/versioning/validate-label-decision.js tools/versioning/label-schema.json artifacts/labels/decision.json

      - name: Apply Deterministic Labels (Repo-only)
        id: apply_labels
        if: github.event.pull_request.head.repo.fork == false
        continue-on-error: true
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const decision = JSON.parse(fs.readFileSync('artifacts/labels/decision.json', 'utf-8'));
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const issue_number = context.payload.pull_request.number;

            for (const label of decision.labels_to_remove) {
              try {
                await github.rest.issues.removeLabel({ owner, repo, issue_number, name: label });
              } catch (error) {
                // ignore missing labels to keep idempotency
              }
            }

            await github.rest.issues.addLabels({
              owner,
              repo,
              issue_number,
              labels: decision.labels_to_add,
            });

      - name: Label Apply Warning
        if: always() && steps.apply_labels.outcome == 'failure'
        run: |
          echo "Auto-label apply failed; continuing (governance fail-open)." | tee artifacts/labels/apply-warning.txt

      - name: Labeling Summary
        run: |
          node -e 'const fs=require("fs");const d=JSON.parse(fs.readFileSync("artifacts/labels/decision.json","utf-8"));const lines=["## PR Labeling Summary","",`- version required: ${d.version_required}`,`- version actual: ${d.version_actual}`,`- version reason: ${d.version_reason}`,`- labels to add: ${d.labels_to_add.join(", ")}`,`- labels to remove: ${d.labels_to_remove.join(", ") || "none"}`,"","### Decision Trace",`- changed files: ${d.decision_trace.changed_files_count}`,`- selected primary: ${d.decision_trace.selected_primary}`,`- selected impl: ${d.decision_trace.selected_impl || "none"}`,`- selected areas: ${(d.decision_trace.selected_areas || []).join(", ") || "none"}`];fs.appendFileSync(process.env.GITHUB_STEP_SUMMARY, lines.join("\n")+"\n");'

      - name: Upload Label Decision Artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: pr-label-decision
          path: artifacts/labels/
          if-no-files-found: error

  preflight:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "10.0.x"

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Label Engine Golden Tests
        run: node tools/versioning/test-compute-pr-labels.js

      - name: Docs Check
        run: |
          set -euo pipefail
          mkdir -p artifacts/docs
          python3 tools/check-docs.py | tee artifacts/docs/doc-check.txt

      - name: Versioning Guard
        run: |
          set -euo pipefail
          mkdir -p artifacts/versioning
          bash tools/versioning/check-versioning.sh | tee artifacts/versioning/versioning-check.txt

      - name: Format Check
        run: |
          set -euo pipefail
          mkdir -p artifacts/format
          dotnet format FileClassifier.sln --verify-no-changes | tee artifacts/format/format-check.txt

      - name: Upload Docs Artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: docs-check
          path: artifacts/docs/
          if-no-files-found: error

      - name: Upload Versioning Artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: versioning-check
          path: artifacts/versioning/
          if-no-files-found: error

      - name: Upload Format Artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: format-check
          path: artifacts/format/
          if-no-files-found: error

  build:
    runs-on: ubuntu-latest
    needs: preflight

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "10.0.x"

      - name: Restore
        run: dotnet restore FileClassifier.sln -v minimal

      - name: Build (Warnings As Errors)
        run: |
          set -euo pipefail
          mkdir -p artifacts/build
          dotnet build FileClassifier.sln --no-restore -warnaserror -v minimal | tee artifacts/build/build-log.txt

      - name: Upload Build Artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: build-log
          path: artifacts/build/
          if-no-files-found: error

  security-nuget:
    runs-on: ubuntu-latest
    needs: build

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "10.0.x"

      - name: Restore
        run: dotnet restore FileClassifier.sln -v minimal

      - name: NuGet Vulnerability Scan
        run: |
          set -euo pipefail
          mkdir -p artifacts/security
          dotnet list FileClassifier.sln package --vulnerable --include-transitive | tee artifacts/security/nuget-vuln.txt
          if grep -E "\b(High|Critical)\b" artifacts/security/nuget-vuln.txt; then
            echo "High/Critical vulnerabilities detected."
            exit 1
          fi

      - name: NuGet Deprecated Packages
        run: |
          set -euo pipefail
          mkdir -p artifacts/security
          dotnet list FileClassifier.sln package --deprecated | tee artifacts/security/nuget-deprecated.txt

      - name: Upload Security Artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: nuget-security
          path: artifacts/security/
          if-no-files-found: error

  tests-bdd-coverage:
    runs-on: ubuntu-latest
    needs: build

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "10.0.x"

      - name: Restore
        run: dotnet restore FileClassifier.sln -v minimal

      - name: BDD Tests + Coverage Gate (Single Run)
        run: |
          set -euo pipefail
          mkdir -p artifacts/tests artifacts/coverage
          TEST_BDD_OUTPUT_DIR="${{ github.workspace }}/artifacts/tests" \
            bash tools/test-bdd-readable.sh -- \
              /p:CollectCoverage=true \
              /p:Include="[FileTypeDetectionLib]*" \
              /p:CoverletOutputFormat=cobertura \
              /p:CoverletOutput="${{ github.workspace }}/artifacts/coverage/coverage" \
              /p:Threshold=85%2c69 \
              /p:ThresholdType=line%2cbranch \
              /p:ThresholdStat=total

      - name: Upload Test Artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: bdd-test-results
          path: artifacts/tests/
          if-no-files-found: error

      - name: Upload Coverage Artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: artifacts/coverage/
          if-no-files-found: error

  summary:
    runs-on: ubuntu-latest
    needs: [security-nuget, tests-bdd-coverage]

    steps:
      - name: Download Coverage Artifact
        uses: actions/download-artifact@v4
        with:
          name: coverage-report
          path: artifacts/coverage

      - name: Download Security Artifact
        uses: actions/download-artifact@v4
        with:
          name: nuget-security
          path: artifacts/security

      - name: CI Summary
        run: |
          set -euo pipefail
          {
            echo "## CI Summary"
            echo ""
            echo "### Coverage"
            if [[ -f artifacts/coverage/coverage-summary.txt ]]; then
              cat artifacts/coverage/coverage-summary.txt
            else
              echo "Coverage summary not found."
            fi
            echo ""
            echo "### NuGet Vulnerabilities"
            if [[ -f artifacts/security/nuget-vuln.txt ]]; then
              tail -n 200 artifacts/security/nuget-vuln.txt
            else
              echo "NuGet vulnerability report not found."
            fi
          } >> "$GITHUB_STEP_SUMMARY"
