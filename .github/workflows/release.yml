name: Release Publish

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:
    inputs:
      release_tag:
        description: "Tag to publish (format: vMAJOR.MINOR.PATCH[-prerelease])"
        required: true
        type: string

permissions:
  contents: read

jobs:
  tag-gate:
    runs-on: ubuntu-latest
    if: (github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v')) || github.event_name == 'workflow_dispatch'
    permissions:
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
        with:
          fetch-depth: 0
          fetch-tags: true
      - name: Setup Node
        uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4
        with:
          node-version: "20"
      - name: Tag gate (fail-closed)
        env:
          RELEASE_TAG: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.release_tag || github.ref_name }}
          OUT_DIR: artifacts/tag-gate
        run: node tools/versioning/tag-gate.js
      - name: Upload tag-gate artifact
        if: always()
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
        with:
          name: tag-gate-artifacts
          path: artifacts/tag-gate/
          if-no-files-found: error

  version-policy:
    runs-on: ubuntu-latest
    needs: tag-gate
    if: (github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v')) || github.event_name == 'workflow_dispatch'
    permissions:
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
        with:
          fetch-depth: 0

      - name: Setup .NET
        uses: actions/setup-dotnet@67a3573c9a986a3f9c594539f4ab511d57bb3ce9 # v4
        with:
          dotnet-version: |
            8.0.x
            10.0.102

      - name: Gate 0 - Naming SNT
        run: bash tools/ci/release/gate0_naming_snt.sh "${GITHUB_WORKSPACE}"

      - name: Gate 0b - Assert naming summary pass
        run: bash tools/ci/release/assert_naming_summary_pass.sh "${GITHUB_WORKSPACE}/artifacts/nuget/naming-snt-summary.json"

      - name: Gate 1 - Validate release tag and derive version
        id: tag
        shell: bash
        env:
          RELEASE_TAG: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.release_tag || github.ref_name }}
        run: bash tools/ci/release/derive_tag_outputs.sh

      - name: Restore (locked mode)
        run: dotnet restore --locked-mode FileClassifier.sln -v minimal

      - name: Restore CSCore (out-of-solution)
        run: dotnet restore --locked-mode src/FileClassifier.CSCore/FileClassifier.CSCore.csproj -v minimal

      - name: Build
        run: dotnet build FileClassifier.sln -c Release --no-restore -warnaserror -v minimal

      - name: Source-based tests
        run: dotnet test --project tests/FileTypeDetectionLib.Tests/FileTypeDetectionLib.Tests.csproj -c Release --no-build -v minimal

      - name: Fuzz tests (release blocker)
        run: dotnet test --project tests/FileTypeDetectionLib.Tests/FileTypeDetectionLib.Tests.csproj -c Release --no-build --filter "Category=Fuzz" -v minimal

      - name: API contract tests
        run: dotnet test --project tests/FileTypeDetectionLib.Tests/FileTypeDetectionLib.Tests.csproj -c Release --no-build --filter "Category=ApiContract" -v minimal

      - name: Pack with tag version (SSOT)
        run: bash tools/ci/release/pack_with_tag.sh "${{ steps.tag.outputs.version }}" "${{ steps.tag.outputs.tag }}" "${{ steps.tag.outputs.assembly_version }}" "${{ steps.tag.outputs.file_version }}"

      - name: Resolve nupkg path
        id: nupkg
        shell: bash
        run: bash tools/ci/release/resolve_nupkg_path.sh artifacts/nuget

      - name: Gate 2 - Verify TagVersion == PackageVersion
        shell: bash
        run: bash tools/ci/release/gate2_version_policy.sh release "${{ steps.tag.outputs.tag }}" "${{ steps.nupkg.outputs.path }}"

      - name: Gate 3 - SVT pre-publish (tag version == nupkg version)
        shell: bash
        run: bash tools/ci/release/gate3_verify_prepublish.sh "${{ steps.tag.outputs.version }}" "${{ steps.nupkg.outputs.path }}"

      - name: Consumer smoke against packed package
        run: bash tools/ci/release/consumer_smoke_from_pack.sh "${{ steps.tag.outputs.version }}"

      - name: Package-backed tests against packed package
        run: bash tools/ci/release/package_backed_from_pack.sh "${{ steps.tag.outputs.version }}"

      - name: Upload package artifact
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
        with:
          name: nuget-package
          path: artifacts/nuget/
          if-no-files-found: error

      - name: Upload naming SNT summary
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
        with:
          name: release-naming-snt-summary
          path: artifacts/nuget/naming-snt-summary.json
          if-no-files-found: error

      - name: Prepare release metadata artifact
        shell: bash
        run: bash tools/ci/release/write_release_meta_artifact.sh "${{ steps.tag.outputs.tag }}" "${{ steps.tag.outputs.version }}" "https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}" "artifacts/release-meta/release-meta.json"

      - name: Upload release metadata artifact
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
        with:
          name: release-meta
          path: artifacts/release-meta/release-meta.json
          if-no-files-found: error

  publish-nuget:
    runs-on: ubuntu-latest
    needs: version-policy
    if: (github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v')) || github.event_name == 'workflow_dispatch'
    permissions:
      contents: write
      packages: write
      id-token: write
      attestations: write
    steps:
      - name: Checkout
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: Setup .NET
        uses: actions/setup-dotnet@67a3573c9a986a3f9c594539f4ab511d57bb3ce9 # v4
        with:
          dotnet-version: |
            8.0.x
            10.0.102

      - name: Download package artifact
        uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093 # v4
        with:
          name: nuget-package
          path: artifacts/nuget/

      - name: Download naming SNT summary
        uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093 # v4
        with:
          name: release-naming-snt-summary
          path: artifacts/nuget/

      - name: Gate 0c - Re-assert naming summary pass
        run: bash tools/ci/release/assert_naming_summary_pass.sh artifacts/nuget/naming-snt-summary.json

      - name: Resolve nupkg path
        id: nupkg
        shell: bash
        run: bash tools/ci/release/resolve_nupkg_path.sh artifacts/nuget

      - name: NuGet login (OIDC / Trusted Publishing)
        uses: NuGet/login@d22cc5f58ff5b88bf9bd452535b4335137e24544 # v1
        id: nuget_login
        with:
          user: Tomtastisch

      - name: "Fail-closed: assert OIDC temp key present"
        shell: bash
        run: |
          set -euo pipefail
          test -n "${{ steps.nuget_login.outputs.NUGET_API_KEY }}"

      - name: Publish to NuGet
        env:
          NUGET_API_KEY: ${{ steps.nuget_login.outputs.NUGET_API_KEY }}
        run: bash tools/ci/release/publish_nuget.sh "${{ steps.nupkg.outputs.path }}"

      - name: Publish to GitHub Packages (NuGet Registry)
        env:
          GITHUB_TOKEN: ${{ github.token }}
        run: bash tools/ci/release/publish_github_packages.sh "${{ steps.nupkg.outputs.path }}" "https://nuget.pkg.github.com/${{ github.repository_owner }}/index.json"

      - name: Create or update GitHub Release (stable/rc by tag)
        env:
          GH_TOKEN: ${{ github.token }}
          RELEASE_TAG: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.release_tag || github.ref_name }}
        run: bash tools/ci/release/upsert_github_release.sh

      - name: "Post-check: stable release must be Latest"
        if: (github.event_name != 'workflow_dispatch' && !contains(github.ref_name, '-rc.')) || (github.event_name == 'workflow_dispatch' && !contains(github.event.inputs.release_tag, '-rc.'))
        env:
          GH_TOKEN: ${{ github.token }}
          RELEASE_TAG: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.release_tag || github.ref_name }}
          REPO: ${{ github.repository }}
        shell: bash
        run: |
          set -euo pipefail
          latest_tag="$(gh api "repos/${REPO}/releases/latest" --jq .tag_name)"
          [[ "${latest_tag}" == "${RELEASE_TAG}" ]] || { echo "ERROR: Latest release tag '${latest_tag}' does not match expected '${RELEASE_TAG}'" >&2; exit 1; }

      - name: Attest package provenance
        uses: actions/attest-build-provenance@e8998f949152b193b063cb0ec769d69d929409be # v2
        with:
          subject-path: "${{ steps.nupkg.outputs.path }}"

      - name: Verify package attestation
        env:
          GH_TOKEN: ${{ github.token }}
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p artifacts/nuget
          gh attestation verify "${{ steps.nupkg.outputs.path }}" --repo "${{ github.repository }}" > artifacts/nuget/attestation-verify.txt

      - name: Upload attestation verification artifact
        if: always()
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
        with:
          name: nuget-attestation-verify
          path: artifacts/nuget/attestation-verify.txt
          if-no-files-found: warn

      - name: Gate 4 - SVT post-publish (git version == package version == nuget version)
        shell: bash
        env:
          RELEASE_TAG: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.release_tag || github.ref_name }}
        run: bash tools/ci/release/gate4_verify_postpublish.sh "${RELEASE_TAG#v}" "${{ steps.nupkg.outputs.path }}"

  enforce-online-convergence:
    runs-on: ubuntu-latest
    needs: publish-nuget
    if: (github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v')) || github.event_name == 'workflow_dispatch'
    permissions:
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: Download release metadata artifact
        uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093 # v4
        with:
          name: release-meta
          path: artifacts/release-meta/

      - name: Resolve release metadata
        id: meta
        env:
          RELEASE_RUN_URL: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
        shell: bash
        run: bash tools/ci/release/resolve_workflow_run_release_meta.sh artifacts/release-meta/release-meta.json "${RELEASE_RUN_URL}"

      - name: Verify NuGet online convergence (all endpoints required)
        shell: bash
        run: bash tools/ci/release/verify_nuget_online_convergence.sh "${{ steps.meta.outputs.release_version }}" "${{ steps.meta.outputs.verify_log_path }}" "${{ steps.meta.outputs.package_id }}"

      - name: Upload convergence artifact
        if: always()
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
        with:
          name: nuget-online-convergence-sync
          path: artifacts/ci/nuget-online-convergence/
          if-no-files-found: error
