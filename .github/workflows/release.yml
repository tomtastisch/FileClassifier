name: Release Publish

on:
  push:
    tags:
      - "v*"

permissions:
  contents: read

jobs:
  version-policy:
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: |
            8.0.x
            10.0.102

      - name: Gate 0 - Naming SNT
        run: bash tools/ci/release/gate0_naming_snt.sh "${GITHUB_WORKSPACE}"

      - name: Gate 0b - Assert naming summary pass
        run: bash tools/ci/release/assert_naming_summary_pass.sh "${GITHUB_WORKSPACE}/artifacts/nuget/naming-snt-summary.json"

      - name: Gate 1 - Validate release tag and derive version
        id: tag
        shell: bash
        run: bash tools/ci/release/derive_tag_outputs.sh

      - name: Restore (locked mode)
        run: dotnet restore --locked-mode FileClassifier.sln -v minimal

      - name: Build
        run: dotnet build FileClassifier.sln -c Release --no-restore -warnaserror -v minimal

      - name: Source-based tests
        run: dotnet test tests/FileTypeDetectionLib.Tests/FileTypeDetectionLib.Tests.csproj -c Release --no-build -v minimal

      - name: API contract tests
        run: dotnet test tests/FileTypeDetectionLib.Tests/FileTypeDetectionLib.Tests.csproj -c Release --no-build --filter "Category=ApiContract" -v minimal

      - name: Pack with tag version (SSOT)
        run: bash tools/ci/release/pack_with_tag.sh "${{ steps.tag.outputs.version }}" "${{ steps.tag.outputs.tag }}" "${{ steps.tag.outputs.assembly_version }}" "${{ steps.tag.outputs.file_version }}"

      - name: Resolve nupkg path
        id: nupkg
        shell: bash
        run: bash tools/ci/release/resolve_nupkg_path.sh artifacts/nuget

      - name: Gate 2 - Verify TagVersion == PackageVersion
        shell: bash
        run: bash tools/ci/release/gate2_version_policy.sh release "${{ steps.tag.outputs.tag }}" "${{ steps.nupkg.outputs.path }}"

      - name: Gate 3 - SVT pre-publish (tag version == nupkg version)
        shell: bash
        run: bash tools/ci/release/gate3_verify_prepublish.sh "${{ steps.tag.outputs.version }}" "${{ steps.nupkg.outputs.path }}"

      - name: Consumer smoke against packed package
        run: bash tools/ci/release/consumer_smoke_from_pack.sh "${{ steps.tag.outputs.version }}"

      - name: Package-backed tests against packed package
        run: bash tools/ci/release/package_backed_from_pack.sh "${{ steps.tag.outputs.version }}"

      - name: Upload package artifact
        uses: actions/upload-artifact@v4
        with:
          name: nuget-package
          path: artifacts/nuget/
          if-no-files-found: error

      - name: Upload naming SNT summary
        uses: actions/upload-artifact@v4
        with:
          name: release-naming-snt-summary
          path: artifacts/nuget/naming-snt-summary.json
          if-no-files-found: error

  publish-nuget:
    runs-on: ubuntu-latest
    needs: version-policy
    if: startsWith(github.ref, 'refs/tags/v')
    permissions:
      contents: read
      id-token: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: |
            8.0.x
            10.0.102

      - name: Download package artifact
        uses: actions/download-artifact@v4
        with:
          name: nuget-package
          path: artifacts/nuget/

      - name: Download naming SNT summary
        uses: actions/download-artifact@v4
        with:
          name: release-naming-snt-summary
          path: artifacts/nuget/

      - name: Gate 0c - Re-assert naming summary pass
        run: bash tools/ci/release/assert_naming_summary_pass.sh artifacts/nuget/naming-snt-summary.json

      - name: Resolve nupkg path
        id: nupkg
        shell: bash
        run: bash tools/ci/release/resolve_nupkg_path.sh artifacts/nuget

      - name: NuGet login (OIDC / Trusted Publishing)
        uses: NuGet/login@v1
        id: nuget_login
        with:
          user: Tomtastisch

      - name: "Fail-closed: assert OIDC temp key present"
        shell: bash
        run: |
          set -euo pipefail
          test -n "${{ steps.nuget_login.outputs.NUGET_API_KEY }}"

      - name: Publish to NuGet
        env:
          NUGET_API_KEY: ${{ steps.nuget_login.outputs.NUGET_API_KEY }}
        run: bash tools/ci/release/publish_nuget.sh "${{ steps.nupkg.outputs.path }}"

      - name: Gate 4 - SVT post-publish (git version == package version == nuget version)
        shell: bash
        run: bash tools/ci/release/gate4_verify_postpublish.sh "${GITHUB_REF_NAME#v}" "${{ steps.nupkg.outputs.path }}"
