name: NuGet Online Convergence

on:
  workflow_run:
    workflows: ["Release Publish"]
    types: [completed]

permissions:
  contents: read
  actions: read

jobs:
  verify-convergence:
    if: github.event.workflow_run.conclusion == 'success' && github.event.workflow_run.head_repository.full_name == github.repository && github.event.workflow_run.event == 'push'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      actions: read
    outputs:
      release_tag: ${{ steps.meta.outputs.release_tag }}
      release_version: ${{ steps.meta.outputs.release_version }}
      release_run_url: ${{ steps.meta.outputs.release_run_url }}
      verify_log_path: ${{ steps.meta.outputs.verify_log_path }}
      package_id: ${{ steps.meta.outputs.package_id }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_sha }}

      - name: Resolve release metadata
        id: meta
        env:
          RELEASE_TAG: ${{ github.event.workflow_run.head_branch }}
          RELEASE_RUN_URL: ${{ github.event.workflow_run.html_url }}
        shell: bash
        run: bash tools/ci/release/resolve_workflow_run_release_meta.sh "${RELEASE_TAG}" "${RELEASE_RUN_URL}"

      - name: Verify NuGet online convergence (all endpoints required)
        shell: bash
        run: bash tools/ci/release/verify_nuget_online_convergence.sh "${{ steps.meta.outputs.release_version }}" "${{ steps.meta.outputs.verify_log_path }}" "${{ steps.meta.outputs.package_id }}"

      - name: Upload convergence artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: nuget-online-convergence
          path: artifacts/ci/nuget-online-convergence/
          if-no-files-found: error

  escalate-on-failure:
    needs: verify-convergence
    if: needs.verify-convergence.result == 'failure'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write
    steps:
      - name: Create or update convergence incident issue
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const tag = `${{ needs.verify-convergence.outputs.release_tag }}`;
            const version = `${{ needs.verify-convergence.outputs.release_version }}`;
            const releaseRunUrl = `${{ needs.verify-convergence.outputs.release_run_url }}`;
            const thisRunUrl = `https://github.com/${owner}/${repo}/actions/runs/${context.runId}`;
            const title = `[nuget-convergence] ${tag} not converged within async window`;
            const body = [
              "NuGet online convergence failed after async retry window.",
              "",
              `- Tag: \`${tag}\``,
              `- Version: \`${version}\``,
              `- Source Release Run: ${releaseRunUrl}`,
              `- Convergence Run: ${thisRunUrl}`,
              "",
              "Please inspect the `nuget-online-convergence` artifact (`verify.log`) for endpoint-level evidence."
            ].join("\n");

            const issues = await github.paginate(github.rest.issues.listForRepo, {
              owner,
              repo,
              state: "open",
              per_page: 100
            });

            const existing = issues.find((issue) => !issue.pull_request && issue.title === title);
            if (existing) {
              await github.rest.issues.createComment({
                owner,
                repo,
                issue_number: existing.number,
                body
              });
            } else {
              await github.rest.issues.create({
                owner,
                repo,
                title,
                body
              });
            }
