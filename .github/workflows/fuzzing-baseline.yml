name: fuzzing-baseline

on:
  schedule:
    - cron: "17 2 * * 2"
  workflow_dispatch:

permissions:
  contents: read

jobs:
  fuzzing-baseline:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: Setup .NET
        uses: actions/setup-dotnet@67a3573c9a986a3f9c594539f4ab511d57bb3ce9 # v4
        with:
          dotnet-version: |
            8.0.x
            10.0.102

      - name: Restore
        run: dotnet restore --locked-mode FileClassifier.sln -v minimal

      - name: Build
        run: dotnet build FileClassifier.sln -c Release --no-restore -warnaserror -v minimal

      - name: Execute fuzz baseline suite (report-only)
        shell: bash
        run: |
          mkdir -p artifacts/ci/fuzzing-baseline
          dotnet test tests/FileTypeDetectionLib.Tests/FileTypeDetectionLib.Tests.csproj -c Release --no-build --filter "Category=Fuzz" -v minimal > artifacts/ci/fuzzing-baseline/fuzz.log
          echo "fuzzing baseline completed" > artifacts/ci/fuzzing-baseline/summary.txt

      - name: Upload artifact
        if: always()
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: ci-fuzzing-baseline
          path: artifacts/ci/fuzzing-baseline/
          if-no-files-found: error
