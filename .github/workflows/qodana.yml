name: qodana

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]
  workflow_dispatch:

permissions:
  contents: read
  security-events: write

jobs:
  qodana:
    runs-on: ubuntu-latest
    env:
      QODANA_TOKEN: ${{ secrets.QODANA_TOKEN }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Run Qodana
        if: env.QODANA_TOKEN != ''
        uses: JetBrains/qodana-action@v2025.3
        with:
          image: jetbrains/qodana-dotnet:2025.3
          results-dir: qodana-results
          upload-result: false

      - name: Upload SARIF To Code Scanning
        if: env.QODANA_TOKEN != '' && github.event_name != 'pull_request'
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: qodana-results/qodana.sarif.json

      - name: Upload SARIF Artifact
        if: env.QODANA_TOKEN != ''
        uses: actions/upload-artifact@v4
        with:
          name: qodana-sarif
          path: qodana-results/qodana.sarif.json
          if-no-files-found: error

      - name: Skip Message (No Token)
        if: env.QODANA_TOKEN == ''
        run: echo "QODANA_TOKEN not set; qodana scan skipped."
