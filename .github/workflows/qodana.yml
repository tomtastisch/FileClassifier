name: Qodana

on:
  pull_request:
  workflow_dispatch:
  push:
    branches: [ "main" ]

jobs:
  qodana:
    runs-on: ubuntu-latest

    permissions:
      contents: read
      security-events: write
      pull-requests: write

    steps:
      - name: Checkout (full history for merge-base)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Qodana Scan
        uses: JetBrains/qodana-action@v2025.3

      # Robust: SARIF unabhÃ¤ngig vom Pfad finden und als Output bereitstellen
      - name: Locate SARIF
        id: sarif
        if: always()
        shell: bash
        run: |
          set -euo pipefail
          echo "Searching SARIF..."
          # typische Orte + Fallback (workspace)
          CANDIDATES=(
            "${RUNNER_TEMP:-/tmp}/qodana/results/qodana.sarif.json"
            "qodana/results/qodana.sarif.json"
          )
          FOUND=""
          for p in "${CANDIDATES[@]}"; do
            if [ -f "$p" ]; then FOUND="$p"; break; fi
          done
          if [ -z "$FOUND" ]; then
            FOUND="$(find . -maxdepth 6 -type f -iname "*sarif*.json" | head -n 1 || true)"
          fi
          if [ -z "$FOUND" ]; then
            echo "sarif_path=" >> "$GITHUB_OUTPUT"
            echo "No SARIF found."
            exit 0
          fi
          echo "Found SARIF at: $FOUND"
          echo "sarif_path=$FOUND" >> "$GITHUB_OUTPUT"

      - name: Upload SARIF to GitHub Code Scanning
        if: always() && steps.sarif.outputs.sarif_path != ''
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: ${{ steps.sarif.outputs.sarif_path }}

      - name: Upload SARIF artifact
        if: always() && steps.sarif.outputs.sarif_path != ''
        uses: actions/upload-artifact@v4
        with:
          name: qodana-sarif
          path: ${{ steps.sarif.outputs.sarif_path }}
          if-no-files-found: warn

      - name: Comment SARIF summary on PR
        if: always() && github.event_name == 'pull_request' && steps.sarif.outputs.sarif_path != ''
        uses: actions/github-script@v7
        env:
          SARIF_PATH: ${{ steps.sarif.outputs.sarif_path }}
        with:
          script: |
            const fs = require('fs');
            const p = process.env.SARIF_PATH;
            if (!fs.existsSync(p)) {
              core.warning(`SARIF not found at ${p}`);
              return;
            }
            const sarif = JSON.parse(fs.readFileSync(p, 'utf8'));
            const results = (((sarif.runs||[])[0]||{}).results)||[];
            const byRule = new Map();
            for (const r of results) {
              const k = r.ruleId || 'unknown';
              byRule.set(k, (byRule.get(k)||0) + 1);
            }
            const top = [...byRule.entries()].sort((a,b)=>b[1]-a[1]).slice(0,15);
            const lines = top.map(([k,v])=>`- ${k}: ${v}`);
            const body =
              `Qodana Summary\n` +
              `Total results: ${results.length}\n\n` +
              (lines.length ? lines.join('\n') : '(no results)');
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body
            });
