name: qodana

on:
    push:
        branches: ["**"]

permissions:
    contents: read

jobs:
    qodana:
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4

            - name: Debug QODANA_TOKEN presence
              shell: bash
              run: |
                  if [ -z "${QODANA_TOKEN:-}" ]; then
                    echo "ERROR: QODANA_TOKEN is not available in this run context."
                    exit 1
                  fi
                  echo "QODANA_TOKEN is set (length=${#QODANA_TOKEN})"
              env:
                  QODANA_TOKEN: ${{ secrets.QODANA_TOKEN }}

            -   name: Run Qodana
                uses: JetBrains/qodana-action@v2025.3
                env:
                    QODANA_TOKEN: ${{ secrets.QODANA_TOKEN }}
                with:
                    image: jetbrains/qodana-dotnet:2025.3
                    results-dir: qodana-results
                    upload-result: false
            
            
            - name: Upload SARIF artifact
              uses: actions/upload-artifact@v4
              with:
                  name: qodana-sarif
                  path: qodana-results/qodana.sarif.json
                  if-no-files-found: error
