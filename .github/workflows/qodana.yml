name: Qodana

on:
  pull_request:
  workflow_dispatch:
  push:
    # Für jeden Branch durchführen
    branches: [ "**" ]

jobs:
  qodana:
    runs-on: ubuntu-latest

    permissions:
      contents: read
      security-events: write

    steps:
      - name: Checkout (full history for merge-base)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Qodana Scan
        uses: JetBrains/qodana-action@v2025.3

      - name: Locate SARIF (debug)
        id: sarif
        if: always()
        shell: bash
        run: |
          set -euo pipefail
          echo "## SARIF search" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "Runner temp: ${RUNNER_TEMP:-<unset>}" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"

          echo "### Candidate paths" >> "$GITHUB_STEP_SUMMARY"
          printf '%s\n' \
            "${RUNNER_TEMP:-/tmp}/qodana/results/qodana.sarif.json" \
            "qodana/results/qodana.sarif.json" \
            >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"

          FOUND=""
          for p in \
            "${RUNNER_TEMP:-/tmp}/qodana/results/qodana.sarif.json" \
            "qodana/results/qodana.sarif.json"
          do
            if [ -f "$p" ]; then FOUND="$p"; break; fi
          done

          if [ -z "$FOUND" ]; then
            FOUND="$(find . -maxdepth 8 -type f -iname "*sarif*.json" | head -n 1 || true)"
          fi

          echo "### find(.) hits (maxdepth 8)" >> "$GITHUB_STEP_SUMMARY"
          (find . -maxdepth 8 -type f -iname "*sarif*.json" -print || true) >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"

          if [ -z "$FOUND" ]; then
            echo "sarif_path=" >> "$GITHUB_OUTPUT"
            echo "Result: NOT FOUND" >> "$GITHUB_STEP_SUMMARY"
            exit 0
          fi

          echo "sarif_path=$FOUND" >> "$GITHUB_OUTPUT"
          echo "Result: FOUND at $FOUND" >> "$GITHUB_STEP_SUMMARY"

      - name: Upload SARIF to GitHub Code Scanning
        if: always() && steps.sarif.outputs.sarif_path != ''
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: ${{ steps.sarif.outputs.sarif_path }}

      - name: Upload artifacts (sarif + qodana dirs)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: qodana-debug
          path: |
            ${{ runner.temp }}/qodana/**
            qodana/**
            **/*sarif*.json
          if-no-files-found: warn
